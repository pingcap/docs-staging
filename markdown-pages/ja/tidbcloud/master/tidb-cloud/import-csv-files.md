---
title: Import CSV Files from Amazon S3 or GCS into TiDB Cloud
summary: Amazon S3 または GCS からTiDB Cloudに CSV ファイルをインポートする方法を学びます。
aliases: ['/tidbcloud/migrate-from-amazon-s3-or-gcs','/tidbcloud/migrate-from-aurora-bulk-import']
---

# Amazon S3 または GCS から CSV ファイルをTiDB Cloudにインポートする {#import-csv-files-from-amazon-s3-or-gcs-into-tidb-cloud}

このドキュメントでは、Amazon Simple Storage Service (Amazon S3) または Google Cloud Storage (GCS) からTiDB Cloudに CSV ファイルをインポートする方法について説明します。

## 制限事項 {#limitations}

-   データの一貫性を確保するために、 TiDB Cloud、 CSV ファイルを空のテーブルにのみインポートできます。すでにデータが含まれている既存のテーブルにデータをインポートするには、このドキュメントに従ってTiDB Cloud を使用して一時的な空のテーブルにデータをインポートし、 `INSERT SELECT`ステートメントを使用してデータを対象の既存のテーブルにコピーします。

-   TiDB 専用クラスターで[チェンジフィード](/tidb-cloud/changefeed-overview.md)または[ポイントインタイム復元](/tidb-cloud/backup-and-restore.md#turn-on-point-in-time-restore)が有効になっている場合、現在のデータ インポート機能は[物理インポートモード](https://docs.pingcap.com/tidb/stable/tidb-lightning-physical-import-mode)を使用するため、クラスターにデータをインポートできません ( **[データのインポート]**ボタンは無効になります)。このモードでは、インポートされたデータは変更ログを生成しないため、変更フィードとポイントインタイム リストアはインポートされたデータを検出できません。

## ステップ1. CSVファイルを準備する {#step-1-prepare-the-csv-files}

1.  CSV ファイルが 256 MB より大きい場合は、サイズがそれぞれ約 256 MB の小さなファイルに分割することを検討してください。

    TiDB Cloud は非常に大きな CSV ファイルのインポートをサポートしていますが、サイズが約 256 MB の複数の入力ファイルを使用すると最高のパフォーマンスを発揮します。これは、 TiDB Cloud が複数のファイルを並行して処理できるため、インポート速度が大幅に向上するためです。

2.  CSV ファイルに次のように名前を付けます。

    -   CSV ファイルにテーブル全体のすべてのデータが含まれている場合は、データをインポートするときに`${db_name}.${table_name}`テーブルにマップされる`${db_name}.${table_name}.csv`形式でファイルに名前を付けます。

    -   1 つのテーブルのデータが複数の CSV ファイルに分割されている場合は、これらの CSV ファイルに数値サフィックスを追加します。たとえば、 `${db_name}.${table_name}.000001.csv`と`${db_name}.${table_name}.000002.csv` 。数値サフィックスは連続していなくてもかまいませんが、昇順である必要があります。また、すべてのサフィックスが同じ長さになるように、数字の前にゼロを追加する必要があります。

    -   TiDB Cloud は、 `.gzip` 、 `.gz` 、 `.zstd` 、 `.zst` 、 `.snappy`の形式の圧縮ファイルのインポートをサポートしています。圧縮された CSV ファイルをインポートする場合は、ファイルに`${db_name}.${table_name}.${suffix}.csv.${compress}`形式で名前を付けます。13 `${suffix}`オプションで、「000001」などの任意の整数にすることができます。たとえば、 `trips.000001.csv.gz`ファイルを`bikeshare.trips`テーブルにインポートする場合は、ファイルの名前を`bikeshare.trips.000001.csv.gz`に変更する必要があります。

    > **注記：**
    >
    > -   圧縮する必要があるのはデータ ファイルのみであり、データベース ファイルやテーブル スキーマ ファイルは圧縮する必要はありません。
    > -   パフォーマンスを向上させるには、各圧縮ファイルのサイズを 100 MiB に制限することをお勧めします。
    > -   Snappy 圧縮ファイルは[公式Snappyフォーマット](https://github.com/google/snappy)である必要があります。Snappy 圧縮の他のバリエーションはサポートされていません。
    > -   非圧縮ファイルの場合、前述のルールに従って CSV ファイル名を更新できない場合があります (たとえば、CSV ファイル リンクが他のプログラムでも使用されている場合)。ファイル名を変更せずに、 [ステップ4](#step-4-import-csv-files-to-tidb-cloud)の**マッピング設定**を使用してソース データを単一のターゲット テーブルにインポートできます。

## ステップ2. ターゲットテーブルスキーマを作成する {#step-2-create-the-target-table-schemas}

CSV ファイルにはスキーマ情報が含まれていないため、CSV ファイルからTiDB Cloudにデータをインポートする前に、次のいずれかの方法でテーブル スキーマを作成する必要があります。

-   方法 1: TiDB Cloudで、ソース データのターゲット データベースとテーブルを作成します。

-   方法 2: CSV ファイルが保存されている Amazon S3 または GCS ディレクトリで、次のようにソース データのターゲット テーブル スキーマ ファイルを作成します。

    1.  ソース データのデータベース スキーマ ファイルを作成します。

        CSV ファイルが[ステップ1](#step-1-prepare-the-csv-files)の命名規則に従っている場合、データのインポートではデータベース スキーマ ファイルはオプションです。それ以外の場合は、データベース スキーマ ファイルは必須です。

        各データベース スキーマ ファイルは`${db_name}-schema-create.sql`形式で、 `CREATE DATABASE` DDL ステートメントが含まれている必要があります。このファイルを使用して、 TiDB Cloud はデータをインポートするときにデータを格納する`${db_name}`データベースを作成します。

        たとえば、次のステートメントを含む`mydb-scehma-create.sql`ファイルを作成すると、 TiDB Cloud はデータをインポートするときに`mydb`データベースを作成します。

        ```sql
        CREATE DATABASE mydb;
        ```

    2.  ソース データのテーブル スキーマ ファイルを作成します。

        CSV ファイルが配置されている Amazon S3 または GCS ディレクトリにテーブル スキーマ ファイルを含めない場合、 TiDB Cloud はデータをインポートするときに対応するテーブルを作成しません。

        各テーブル スキーマ ファイルは`${db_name}.${table_name}-schema.sql`形式で、 `CREATE TABLE` DDL ステートメントが含まれている必要があります。このファイルを使用すると、 TiDB Cloud はデータをインポートするときに`${db_name}`データベースに`${db_table}`テーブルを作成します。

        たとえば、次のステートメントを含む`mydb.mytable-schema.sql`ファイルを作成すると、 TiDB Cloud はデータをインポートするときに`mydb`データベースに`mytable`テーブルを作成します。

        ```sql
        CREATE TABLE mytable (
        ID INT,
        REGION VARCHAR(20),
        COUNT INT );
        ```

        > **注記：**
        >
        > `${db_name}.${table_name}-schema.sql`ファイルには 1 つの DDL ステートメントのみを含める必要があります。ファイルに複数の DDL ステートメントが含まれている場合、最初のステートメントのみが有効になります。

## ステップ3. クロスアカウントアクセスを構成する {#step-3-configure-cross-account-access}

TiDB Cloud がAmazon S3 または GCS バケット内の CSV ファイルにアクセスできるようにするには、次のいずれかを実行します。

-   CSV ファイルが Amazon S3 にある場合は、 [Amazon S3 アクセスを構成する](/tidb-cloud/config-s3-and-gcs-access.md#configure-amazon-s3-access) 。

    バケットにアクセスするには、AWS アクセスキーまたはロール ARN のいずれかを使用できます。完了したら、アクセスキー (アクセスキー ID とシークレットアクセスキーを含む) またはロール ARN 値をメモしてください。これらは[ステップ4](#step-4-import-csv-files-to-tidb-cloud)で必要になります。

-   CSV ファイルが GCS にある場合は、 [GCS アクセスを構成する](/tidb-cloud/config-s3-and-gcs-access.md#configure-gcs-access) 。

## ステップ4. CSVファイルをTiDB Cloudにインポートする {#step-4-import-csv-files-to-tidb-cloud}

CSV ファイルをTiDB Cloudにインポートするには、次の手順を実行します。

1.  ターゲット クラスターの**インポート**ページを開きます。

    1.  [TiDB Cloudコンソール](https://tidbcloud.com/)にログインし、プロジェクトの[**クラスター**](https://tidbcloud.com/console/clusters)ページに移動します。

        > **ヒント：**
        >
        > 複数のプロジェクトがある場合は、<mdsvgicon name="icon-left-projects">左下隅にある をクリックして、別のプロジェクトに切り替えます。</mdsvgicon>

    2.  ターゲット クラスターの名前をクリックして概要ページに移動し、左側のナビゲーション ペインで**[インポート] を**クリックします。

2.  **インポート**ページで:

    -   TiDB 専用クラスターの場合は、右上隅の**[データのインポート] を**クリックします。
    -   TiDB Serverless クラスターの場合は、アップロード領域の上にある**S3 からのデータのインポート**リンクをクリックします。

3.  ソース CSV ファイルに次の情報を提供します。

    クラスターの場所に応じて、Amazon S3 または GCS からデータをインポートすることを選択できます。

    <SimpleTab>
     <div label="Amazon S3">

    -   **場所**: **Amazon S3**を選択します。

    -   **データ形式**: **CSV**を選択します。CSV 設定を編集する必要がある場合は、 **CSV 設定の編集を**クリックして、CSV 固有の設定を更新します。詳細については、 [データをインポートするための CSV 構成](/tidb-cloud/csv-config-for-import-data.md)を参照してください。

        > **注記：**
        >
        > セパレーターと区切り文字の設定では、英数字と特定の特殊文字の両方を使用できます。サポートされている特殊文字には、 `\t` 、 `\b` 、 `\n` 、 `\r` 、 `\f` 、および`\u0001`があります。

    -   **バケット URI** : CSV ファイルが保存されているバケット URI を選択します。URI の末尾に`/`を含める必要があることに注意してください (例: `s3://sampledate/ingest/` )。

    -   **バケットアクセス**(このフィールドは AWS S3 でのみ表示されます): バケットにアクセスするには、AWS アクセスキーまたは AWS ロール ARN のいずれかを使用できます。詳細については、 [Amazon S3 アクセスを構成する](/tidb-cloud/config-s3-and-gcs-access.md#configure-amazon-s3-access)を参照してください。
        -   **AWS アクセスキー**: AWS アクセスキー ID と AWS シークレットアクセスキーを入力します。
        -   **AWS ロール ARN** : AWS ロール ARN 値を入力します。

    </div>
     <div label="GCS">

    -   **場所**: **Google Cloud**を使用します。

    -   **データ形式**: **CSV**を選択します。CSV 設定を編集する必要がある場合は、 **CSV 設定の編集を**クリックして、CSV 固有の設定を更新します。詳細については、 [データをインポートするための CSV 構成](/tidb-cloud/csv-config-for-import-data.md)を参照してください。

        > **注記：**
        >
        > セパレーターと区切り文字の設定では、英数字と特定の特殊文字の両方を使用できます。サポートされている特殊文字には、 `\t` 、 `\b` 、 `\n` 、 `\r` 、 `\f` 、および`\u0001`があります。

    -   **バケット gsutil URI** : CSV ファイルが保存されているバケット gsutil URI を選択します。URI の末尾に`/`を含める必要があることに注意してください (例: `gs://sampledate/ingest/` )。

    -   **バケット アクセス**: GCS IAMロールを使用してバケットにアクセスできます。詳細については、 [GCS アクセスを構成する](/tidb-cloud/config-s3-and-gcs-access.md#configure-gcs-access)を参照してください。

    </div>
     </SimpleTab>

4.  事前に作成されたテーブルにインポートするか、ソースからスキーマとデータをインポートするかを選択できます。

    -   **事前に作成されたテーブルにインポートすると、** TiDB に事前にテーブルを作成し、データをインポートするテーブルを選択できます。この場合、インポートするテーブルを最大 1000 個選択できます。テーブルを作成するには、左側のナビゲーション ペインで**[SQL エディター]**をクリックします。SQL エディターの使用方法の詳細については、 [AI支援SQLエディターでデータを探索](/tidb-cloud/explore-data-with-chat2query.md)を参照してください。
    -   **S3 からスキーマとデータをインポートする**(このフィールドは AWS S3 でのみ表示されます) を使用すると、テーブルを作成する SQL スクリプトと、S3 に保存されている対応するデータを TiDB に直接インポートできます。
    -   **GCS からスキーマとデータをインポートする**(このフィールドは GCS でのみ表示されます) と、テーブルを作成する SQL スクリプトと、GCS に保存されている対応するデータを TiDB に直接インポートできます。

5.  ソース ファイルが命名規則に準拠していない場合は、各ターゲット テーブルとそれに対応する CSV ファイルに対してカスタム マッピング ルールを定義できます。その後、データ ソース ファイルは、提供されたカスタム マッピング ルールを使用して再スキャンされます。マッピングを変更するには、 **[詳細設定]**に移動して**[マッピング設定]**をクリックします。 **[マッピング設定] は**、事前に作成されたテーブルへのインポートを選択した場合にのみ使用できることに注意してください。

    -   **ターゲット データベース**: 選択したターゲット データベースの名前を入力します。

    -   **ターゲット テーブル**: 選択したターゲット テーブルの名前を入力します。このフィールドでは特定のテーブル名のみが受け入れられるため、ワイルドカードはサポートされていないことに注意してください。

    -   **ソース ファイルの URI と名前**: ソース ファイルの URI と名前を次の形式`s3://[bucket_name]/[data_source_folder]/[file_name].csv`で入力します。たとえば、 `s3://sampledate/ingest/TableName.01.csv`です。ワイルドカードを使用してソース ファイルを一致させることもできます。詳細については、 [マッピング設定](#mapping-settings)を参照してください。

6.  **[インポートの開始]を**クリックします。

7.  インポートの進行状況が**「完了」**と表示されたら、インポートされたテーブルを確認します。

インポート タスクを実行するときに、サポートされていない変換や無効な変換が検出されると、 TiDB Cloud はインポート ジョブを自動的に終了し、インポート エラーを報告します。

インポート エラーが発生した場合は、次の手順を実行します。

1.  部分的にインポートされたテーブルを削除します。
2.  テーブル スキーマ ファイルを確認します。エラーがある場合は、テーブル スキーマ ファイルを修正します。
3.  CSV ファイル内のデータ型を確認します。
4.  インポートタスクをもう一度試してください。

## マッピング設定 {#mapping-settings}

ソース ファイルが命名規則に準拠していない場合は、各ターゲット テーブルとそれに対応する CSV ファイルに対してカスタム マッピング ルールを定義できます。その後、データ ソース ファイルは、提供されたカスタム マッピング ルールを使用して再スキャンされます。マッピングを変更するには、 **[詳細設定]**に移動して**[マッピング設定]**をクリックします。 **[マッピング設定] は**、 **[事前に作成されたテーブルにインポート] を**選択した場合にのみ使用できることに注意してください。

ソース ファイルの URI と名前を**[ソース ファイルの URI と名前]**に入力するときは、次の形式`s3://[bucket_name]/[data_source_folder]/[file_name].csv`になっていることを確認してください。たとえば、 `s3://sampledate/ingest/TableName.01.csv` 。

ソース ファイルを一致させるためにワイルドカードを使用することもできます。例:

-   `s3://[bucket_name]/[data_source_folder]/my-data?.csv` : そのフォルダー内の`my-data`で始まり、その後に 1 文字 ( `my-data1.csv`や`my-data2.csv`など) が続くすべての CSV ファイルが同じターゲット テーブルにインポートされます。

-   `s3://[bucket_name]/[data_source_folder]/my-data*.csv` : フォルダー内の`my-data`で始まるすべての CSV ファイルが同じターゲット テーブルにインポートされます。

サポートされているのは`?`と`*`のみであることに注意してください。

> **注記：**
>
> URI にはデータ ソース フォルダーが含まれている必要があります。

## トラブルシューティング {#troubleshooting}

### データのインポート中に警告を解決する {#resolve-warnings-during-data-import}

**[インポートの開始] を**クリックした後、 `can't find the corresponding source files`などの警告メッセージが表示された場合は、正しいソース ファイルを指定するか、 [データインポートの命名規則](/tidb-cloud/naming-conventions-for-data-import.md)に従って既存のファイルの名前を変更するか、**詳細設定**を使用して変更を加えることで解決してください。

これらの問題を解決した後、データを再度インポートする必要があります。

### インポートされたテーブルに行が 0 行あります {#zero-rows-in-the-imported-tables}

インポートの進行状況が**「完了」**と表示されたら、インポートされたテーブルを確認します。行数がゼロの場合は、入力したバケット URI に一致するデータ ファイルがなかったことを意味します。この場合、正しいソース ファイルを指定するか、 [データインポートの命名規則](/tidb-cloud/naming-conventions-for-data-import.md)に従って既存のファイルの名前を変更するか、**詳細設定**を使用して変更を加えることで、この問題を解決します。その後、それらのテーブルを再度インポートします。
